name: .NET

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_PATH: src/JubanShared/
  PROJECT_FILE: JubanShared.csproj
  SOLUTION_FILE: JubanShared.sln

jobs:
  build:

    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo
        env:
          MONGO_INITDB_ROOT_USERNAME: mongodb
          MONGO_INITDB_ROOT_PASSWORD: mongodb
        ports:
          - 27017:27017
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.301
    - name: bump version
      run: |
        pwd
        echo $GITHUB_REF
        if [ "$GITHUB_REF" == "stable" ]; then ALPHA=""; else ALPHA="-alpha.$GITHUB_RUN_NUMBER"; fi
        sed -i "s/<\/Version/$ALPHA<\/Version/" $PROJECT_PATH$PROJECT_FILE
        sed -i "s/<\/AssemblyVersion/.$GITHUB_RUN_NUMBER<\/AssemblyVersion/" $PROJECT_PATH$PROJECT_FILE
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    - name: Test
      run: |
        dotnet list . package
        dotnet tool install -g dotnet-reportgenerator-globaltool || true
        dotnet test -v n --collect:"XPlat Code Coverage" --no-build 
        find . -name "coverage.cobertura.xml" -exec ~/.dotnet/tools/reportgenerator -reports:'{}' -targetdir:coverage -reporttypes:TextSummary \; -exec cat coverage/Summary.txt \;
        find . -name "coverage.cobertura.xml" -exec ~/.dotnet/tools/reportgenerator -reports:'{}' -targetdir:coverage-html -reporttypes:HtmlInline_AzurePipelines \; 
    - name: Publish
      env: 
        NUGET_KEY: ${{ secrets.NUGET_KEY }}
      run: |
        if [ "$GITHUB_REF" == "stable" ]; then PackConfiguration="Release"; else PackConfiguration="Debug"; fi
        dotnet pack -c $PackConfiguration $PROJECT_PATH$PROJECT_FILE
        dotnet nuget push ${PROJECT_PATH}bin/$PackConfiguration/*.nupkg -k $NUGET_KEY -s https://api.nuget.org/v3/index.json
    - name: Checkout codecoverage
      uses: actions/checkout@v2
      with:
        ref: codecoverage
        path: codecoverage
        